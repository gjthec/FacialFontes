<div class="mx-auto max-w-[980px] p-4">
    <mat-card appearance="outlined" class="rounded-2xl border border-zinc-200 shadow-sm">
        <mat-card-content class="p-4">

            <!-- ERROR (fica em cima quando existir, mas o form fica 100% horizontal) -->
            <mat-card *ngIf="error" appearance="outlined" class="mb-3 rounded-xl border border-red-200 bg-red-50">
                <div class="flex items-start gap-2 p-3 text-sm text-red-800">
                    <mat-icon class="mt-[1px]" color="warn">error</mat-icon>
                    <div>{{ error }}</div>
                </div>
            </mat-card>

            <!-- LINHA ÚNICA -->
            <div class="flex flex-wrap items-center gap-3">

                <!-- Curso -->
                <mat-form-field appearance="outline" class="min-w-[240px] flex-1">
                    <mat-label>Selecione o curso</mat-label>
                    <mat-select [formControl]="form.controls.courseId" (selectionChange)="onSelectCourse()">
                        <mat-option value="">Selecione...</mat-option>
                        <mat-option *ngFor="let c of courses" [value]="c.id">
                            {{ c.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <!-- Matrícula -->
                <mat-form-field appearance="outline" class="min-w-[220px] flex-1">
                    <mat-label>Matrícula</mat-label>
                    <input matInput type="text" [formControl]="form.controls.code" placeholder="Digite a matrícula" />
                </mat-form-field>

                <!-- Validar + loading -->
                <button mat-flat-button color="primary" class="!rounded-xl" (click)="validateEnrollment()"
                    [disabled]="form.invalid || isValidating">
                    <mat-icon>check</mat-icon>
                    Validar
                </button>

                <mat-progress-spinner *ngIf="isValidating" diameter="22" mode="indeterminate"></mat-progress-spinner>

                <!-- Aluno -->
                <span *ngIf="student" class="flex items-center gap-2 text-sm text-zinc-700">
                    <mat-icon color="primary" style="font-size: 18px; height: 18px; width: 18px;">
                        verified
                    </mat-icon>
                    <span class="font-medium text-zinc-900">{{ student.name }}</span>
                </span>

                <!-- Verificar + loading -->
                <button mat-stroked-button color="primary" class="!rounded-xl" (click)="startFaceRecognition()"
                    [disabled]="!student || isVerifyingFace">
                    <mat-icon>photo_camera</mat-icon>
                    Verificar
                </button>

                <mat-progress-spinner *ngIf="isVerifyingFace" diameter="22" mode="indeterminate"></mat-progress-spinner>

                <!-- Status verificação -->
                <span *ngIf="faceScore != null" class="flex items-center gap-2 text-sm text-zinc-700">
                    <mat-icon [color]="faceOk ? 'primary' : 'warn'" style="font-size: 18px; height: 18px; width: 18px;">
                        {{ faceOk ? "check_circle" : "cancel" }}
                    </mat-icon>
                    <span>{{ faceOk ? "Verificado" : "Falhou" }}</span>
                </span>

                <!-- Confirmar + loading -->
                <button mat-flat-button color="accent" class="!rounded-xl" (click)="registerPresence()"
                    [disabled]="!faceOk || isRegistering">
                    <mat-icon>done_all</mat-icon>
                    Confirmar
                </button>

                <mat-progress-spinner *ngIf="isRegistering" diameter="22" mode="indeterminate"></mat-progress-spinner>

                <!-- Reiniciar -->
                <button mat-button class="!rounded-xl" (click)="reset()">
                    <mat-icon>refresh</mat-icon>
                    Reiniciar
                </button>
            </div>

            <!-- RESULTADO (fica abaixo quando existir; o formulário continua horizontal) -->
            <mat-card *ngIf="receipt" appearance="outlined" class="mt-4 rounded-2xl border border-zinc-200 bg-white">
                <mat-card-content class="space-y-3">
                    <div class="flex items-center gap-2 text-zinc-900">
                        <mat-icon color="primary">task_alt</mat-icon>
                        <div class="font-medium">Presença registrada</div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div class="rounded-xl border border-zinc-200 bg-zinc-50 p-3">
                            <div class="text-xs text-zinc-500">Data/Hora</div>
                            <div class="text-sm font-semibold text-zinc-900">{{ receipt.timestampIso }}</div>
                        </div>

                        <div class="rounded-xl border border-zinc-200 bg-zinc-50 p-3">
                            <div class="text-xs text-zinc-500">Localização</div>
                            <div class="text-sm font-semibold text-zinc-900">
                                {{ receipt.location.lat }}, {{ receipt.location.lng }}
                            </div>
                            <div class="text-xs text-zinc-500">± {{ receipt.location.accuracy }}m</div>
                        </div>
                    </div>

                    <img [src]="receipt.photoDataUri" alt="foto"
                        class="w-full rounded-xl border border-zinc-200 bg-white" />
                </mat-card-content>
            </mat-card>

        </mat-card-content>
    </mat-card>
</div>